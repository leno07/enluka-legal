generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  PARALEGAL
  TRAINEE
  SOLICITOR
  SENIOR_SOLICITOR
  SUPERVISOR
  PARTNER
  COLP
  ADMIN
}

enum MatterStatus {
  ACTIVE
  ON_HOLD
  CLOSED
  ARCHIVED
}

enum DirectionStatus {
  DRAFT
  PENDING_REVIEW
  CONFIRMED
  AMENDED
  VACATED
}

enum DocumentCategory {
  COURT_ORDER
  WITNESS_STATEMENT
  EXPERT_REPORT
  SKELETON_ARGUMENT
  CORRESPONDENCE
  EVIDENCE
  PLEADING
  APPLICATION
  OTHER
}

enum BundleStatus {
  DRAFT
  GENERATING
  READY
  FAILED
}

enum NotificationType {
  DEADLINE_REMINDER
  ESCALATION
  ASSIGNMENT
  DIRECTION_PARSED
  BUNDLE_READY
  SYSTEM
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum AcknowledgementStatus {
  PENDING
  REVIEWED
  IN_PROGRESS
  FILED
  DISMISSED
}

enum EscalationTier {
  T_14D
  T_7D
  T_48H
  T_24H
  OVERDUE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  UPLOAD
  DOWNLOAD
  PARSE
  CONFIRM
  ESCALATE
  ACKNOWLEDGE
  SHARE
  GENERATE
}

// ============================================================
// CORE ENTITIES
// ============================================================

model Firm {
  id        String   @id @default(cuid())
  name      String
  sraNumber String?  @map("sra_number")
  address   String?
  phone     String?
  email     String?
  website   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users              User[]
  matters            Matter[]
  escalationPolicies EscalationPolicy[]
  auditLogs          AuditLog[]

  @@map("firms")
}

model User {
  id           String    @id @default(cuid())
  firmId       String    @map("firm_id")
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  role         Role      @default(PARALEGAL)
  supervisorId String?   @map("supervisor_id")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  firm              Firm               @relation(fields: [firmId], references: [id])
  supervisor        User?              @relation("SupervisorRelation", fields: [supervisorId], references: [id])
  supervisees       User[]             @relation("SupervisorRelation")
  refreshTokens     RefreshToken[]
  matterAssignments MatterAssignment[]
  ownedMatters      Matter[]           @relation("MatterOwner")
  notifications     Notification[]
  acknowledgements  Acknowledgement[]
  auditLogs         AuditLog[]         @relation("AuditUser")
  uploadedDocuments Document[]
  createdBundles    Bundle[]

  @@index([firmId])
  @@index([email])
  @@index([supervisorId])
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

// ============================================================
// MATTER MANAGEMENT
// ============================================================

model Matter {
  id              String       @id @default(cuid())
  firmId          String       @map("firm_id")
  reference       String
  title           String
  clientName      String       @map("client_name")
  clientReference String?      @map("client_reference")
  court           String?
  caseNumber      String?      @map("case_number")
  judge           String?
  status          MatterStatus @default(ACTIVE)
  ownerId         String       @map("owner_id")
  description     String?
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  firm           Firm               @relation(fields: [firmId], references: [id])
  owner          User               @relation("MatterOwner", fields: [ownerId], references: [id])
  assignments    MatterAssignment[]
  directions     Direction[]
  documents      Document[]
  bundles        Bundle[]
  calendarEvents CalendarEvent[]

  @@unique([firmId, reference])
  @@index([firmId])
  @@index([ownerId])
  @@index([status])
  @@map("matters")
}

model MatterAssignment {
  id         String   @id @default(cuid())
  matterId   String   @map("matter_id")
  userId     String   @map("user_id")
  role       String   @default("ASSIGNED")
  assignedAt DateTime @default(now()) @map("assigned_at")

  matter Matter @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@unique([matterId, userId])
  @@index([matterId])
  @@index([userId])
  @@map("matter_assignments")
}

// ============================================================
// DIRECTIONS (Court Order Parsing)
// ============================================================

model Direction {
  id               String          @id @default(cuid())
  matterId         String          @map("matter_id")
  sourceDocumentId String?         @map("source_document_id")
  orderNumber      Int             @map("order_number")
  title            String
  description      String
  dueDate          DateTime?       @map("due_date")
  status           DirectionStatus @default(DRAFT)
  confidenceScore  Float?          @map("confidence_score")
  rawExtraction    Json?           @map("raw_extraction")
  confirmedById    String?         @map("confirmed_by_id")
  confirmedAt      DateTime?       @map("confirmed_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  matter         Matter          @relation(fields: [matterId], references: [id], onDelete: Cascade)
  sourceDocument Document?       @relation(fields: [sourceDocumentId], references: [id])
  calendarEvents CalendarEvent[]

  @@index([matterId])
  @@index([status])
  @@index([dueDate])
  @@map("directions")
}

// ============================================================
// CALENDAR & DEADLINES
// ============================================================

model CalendarEvent {
  id            String    @id @default(cuid())
  matterId      String    @map("matter_id")
  directionId   String?   @map("direction_id")
  title         String
  description   String?
  startDate     DateTime  @map("start_date")
  endDate       DateTime? @map("end_date")
  isAllDay      Boolean   @default(true) @map("is_all_day")
  isDeadline    Boolean   @default(true) @map("is_deadline")
  remindersSent Json      @default("[]") @map("reminders_sent")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  matter        Matter         @relation(fields: [matterId], references: [id], onDelete: Cascade)
  direction     Direction?     @relation(fields: [directionId], references: [id])
  notifications Notification[]

  @@index([matterId])
  @@index([startDate])
  @@index([isDeadline, completedAt])
  @@map("calendar_events")
}

// ============================================================
// DOCUMENTS & BUNDLES
// ============================================================

model Document {
  id          String           @id @default(cuid())
  matterId    String           @map("matter_id")
  uploadedBy  String           @map("uploaded_by")
  fileName    String           @map("file_name")
  fileSize    Int              @map("file_size")
  mimeType    String           @map("mime_type")
  storageKey  String           @map("storage_key")
  bucket      String           @default("documents")
  category    DocumentCategory @default(OTHER)
  description String?
  pageCount   Int?             @map("page_count")
  hash        String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  matter          Matter            @relation(fields: [matterId], references: [id], onDelete: Cascade)
  uploader        User              @relation(fields: [uploadedBy], references: [id])
  directions      Direction[]
  bundleDocuments BundleDocument[]

  @@index([matterId])
  @@index([storageKey])
  @@map("documents")
}

model Bundle {
  id           String       @id @default(cuid())
  matterId     String       @map("matter_id")
  createdById  String       @map("created_by_id")
  title        String
  description  String?
  status       BundleStatus @default(DRAFT)
  storageKey   String?      @map("storage_key")
  totalPages   Int?         @map("total_pages")
  generatedAt  DateTime?    @map("generated_at")
  errorMessage String?      @map("error_message")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  matter     Matter           @relation(fields: [matterId], references: [id], onDelete: Cascade)
  createdBy  User             @relation(fields: [createdById], references: [id])
  documents  BundleDocument[]
  shareLinks ShareLink[]

  @@index([matterId])
  @@index([status])
  @@map("bundles")
}

model BundleDocument {
  id         String @id @default(cuid())
  bundleId   String @map("bundle_id")
  documentId String @map("document_id")
  section    String @default("Main")
  position   Int
  startPage  Int?   @map("start_page")
  endPage    Int?   @map("end_page")

  bundle   Bundle   @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id])

  @@unique([bundleId, documentId])
  @@index([bundleId])
  @@map("bundle_documents")
}

model ShareLink {
  id          String    @id @default(cuid())
  bundleId    String    @map("bundle_id")
  token       String    @unique @default(cuid())
  expiresAt   DateTime  @map("expires_at")
  accessCount Int       @default(0) @map("access_count")
  maxAccess   Int?      @map("max_access")
  password    String?
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  bundle Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("share_links")
}

// ============================================================
// NOTIFICATIONS & ESCALATION
// ============================================================

model EscalationPolicy {
  id          String              @id @default(cuid())
  firmId      String              @map("firm_id")
  tier        EscalationTier
  offsetHours Int                 @map("offset_hours")
  escalateTo  String              @map("escalate_to")
  channels    NotificationChannel[]
  isActive    Boolean             @default(true) @map("is_active")
  createdAt   DateTime            @default(now()) @map("created_at")

  firm Firm @relation(fields: [firmId], references: [id])

  @@unique([firmId, tier])
  @@index([firmId])
  @@map("escalation_policies")
}

model Notification {
  id              String              @id @default(cuid())
  userId          String              @map("user_id")
  calendarEventId String?             @map("calendar_event_id")
  type            NotificationType
  channel         NotificationChannel
  title           String
  message         String
  metadata        Json?
  readAt          DateTime?           @map("read_at")
  sentAt          DateTime?           @map("sent_at")
  failedAt        DateTime?           @map("failed_at")
  failureReason   String?             @map("failure_reason")
  createdAt       DateTime            @default(now()) @map("created_at")

  user            User              @relation(fields: [userId], references: [id])
  calendarEvent   CalendarEvent?    @relation(fields: [calendarEventId], references: [id])
  acknowledgement Acknowledgement?

  @@index([userId, readAt])
  @@index([calendarEventId])
  @@index([type])
  @@map("notifications")
}

model Acknowledgement {
  id             String                @id @default(cuid())
  notificationId String                @unique @map("notification_id")
  userId         String                @map("user_id")
  status         AcknowledgementStatus @default(PENDING)
  note           String?
  acknowledgedAt DateTime?             @map("acknowledged_at")
  createdAt      DateTime              @default(now()) @map("created_at")

  notification Notification @relation(fields: [notificationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("acknowledgements")
}

model EscalationEvent {
  id              String         @id @default(cuid())
  calendarEventId String         @map("calendar_event_id")
  tier            EscalationTier
  escalatedToId   String         @map("escalated_to_id")
  reason          String
  resolvedAt      DateTime?      @map("resolved_at")
  createdAt       DateTime       @default(now()) @map("created_at")

  @@index([calendarEventId])
  @@index([escalatedToId])
  @@index([tier])
  @@map("escalation_events")
}

// ============================================================
// AUDIT LOG
// ============================================================

model AuditLog {
  id         String      @id @default(cuid())
  firmId     String      @map("firm_id")
  userId     String?     @map("user_id")
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  oldValue   Json?       @map("old_value")
  newValue   Json?       @map("new_value")
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  createdAt  DateTime    @default(now()) @map("created_at")

  firm Firm  @relation(fields: [firmId], references: [id])
  user User? @relation("AuditUser", fields: [userId], references: [id])

  @@index([firmId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}
